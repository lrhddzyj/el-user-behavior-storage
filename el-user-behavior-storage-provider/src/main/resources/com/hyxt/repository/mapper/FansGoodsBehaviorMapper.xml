<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyxt.repository.mapper.FansGoodsBehaviorMapper">

  <resultMap id="BaseResultMap" type="com.hyxt.domain.behavior.entity.FansGoodsBehavior">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Nov 23 11:47:04 CST 2020.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="shop_id" jdbcType="VARCHAR" property="shopId" />
    <result column="store_id" jdbcType="VARCHAR" property="storeId" />
    <result column="emp_id" jdbcType="VARCHAR" property="empId" />
    <result column="hy_id" jdbcType="VARCHAR" property="hyId" />
    <result column="open_id" jdbcType="VARCHAR" property="openId" />
    <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
    <result column="photo" jdbcType="VARCHAR" property="photo" />
    <result column="goods_id" jdbcType="VARCHAR" property="goodsId" />
    <result column="goods_url" jdbcType="VARCHAR" property="goodsUrl" />
    <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
    <result column="goods_pic_url" jdbcType="VARCHAR" property="goodsPicUrl" />
    <result column="view_status" jdbcType="TINYINT" property="viewStatus" />
    <result column="is_buy" jdbcType="TINYINT" property="isBuy" />
    <result column="is_keep" jdbcType="TINYINT" property="isKeep" />
    <result column="live_time" jdbcType="INTEGER" property="liveTime" />
    <result column="view_date" jdbcType="VARCHAR" property="viewDate" />
    <result column="view_time" jdbcType="VARCHAR" property="viewTime" />
    <result column="visit_total" jdbcType="INTEGER" property="visitTotal" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="data_source" jdbcType="INTEGER" property="dataSource" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="wx_union_id" jdbcType="VARCHAR" property="wxUnionId" />
    <result column="activity_id" jdbcType="VARCHAR" property="activityId" />
    <result column="redirect_url" jdbcType="VARCHAR" property="redirectUrl" />
    <result column="appcode" jdbcType="INTEGER" property="appcode" />
    <result column="uuid" jdbcType="VARCHAR" property="uuid" />
  </resultMap>

  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Nov 23 11:47:04 CST 2020.
    -->
    id, shop_id, store_id, emp_id, hy_id, open_id, nick_name, photo, goods_id, goods_url,
    goods_name, goods_pic_url, view_status, is_buy, is_keep, live_time, view_date, view_time,
    create_time, data_source, type, wx_union_id, activity_id, redirect_url, appcode,uuid
  </sql>

  <sql id="Base_column_list_groupby">
    id, shop_id, store_id, emp_id, hy_id, open_id, nick_name, photo, goods_id, goods_url,
    goods_name, goods_pic_url, view_status, is_buy, is_keep, sum(live_time) as live_time, count(id) as visit_total,view_date, view_time,
    create_time, data_source, type, wx_union_id, activity_id, redirect_url, appcode,uuid
  </sql>

  <select id="findPage" resultMap="BaseResultMap">
    select
    <include refid="Base_column_list_groupby" />
    from fans_goods_behavior
    where shop_id = #{behaviorQueryVo.shopId}
    and create_time > #{behaviorQueryVo.beginDate}
    and create_time  <![CDATA[<]]>  #{behaviorQueryVo.endDate}
    <if test="behaviorQueryVo.appcode != null ">
      and appcode = #{behaviorQueryVo.appcode}
    </if>
    <if test="behaviorQueryVo.storeId != null ">
      and store_id = #{behaviorQueryVo.storeId}
    </if>
    <if test="behaviorQueryVo.empId != null ">
      and emp_id = #{behaviorQueryVo.empId}
    </if>
    <if test="behaviorQueryVo.dataSource != null ">
      and data_source = #{behaviorQueryVo.dataSource}
    </if>
     <if test="behaviorQueryVo.hyId != null ">
      and hy_id = #{behaviorQueryVo.hyId}
    </if>
    <if test="behaviorQueryVo.type != null ">
      and `type` = #{behaviorQueryVo.type}
    </if>
    group by view_date,type,goods_id
    order by create_time desc
  </select>

  <select id="findByUUID" resultType="com.hyxt.domain.behavior.entity.FansGoodsBehavior">
    select
    <include refid="Base_Column_List" />
    from fans_goods_behavior
    where uuid = #{uuid}
    and appcode = #{appcode}
  </select>

  <update id="updateViewStatusAndTime">
    update fans_goods_behavior
    set view_status = #{viewStatus},live_time = #{liveTime}
    where id=#{id} and appcode = #{appcode}
  </update>

  <select id="findTables" resultType="java.lang.String">
    SELECT table_name FROM information_schema.TABLES
    WHERE table_schema = #{databaseName} AND
    table_name like   #{tablePrefix}
  </select>


  <select id="createTable">
    CREATE TABLE if not exists `${tableName}` (
    `id` varchar(64) NOT NULL COMMENT '主键id',
    `shop_id` varchar(64) NOT NULL COMMENT '商家编号',
    `store_id` varchar(64) DEFAULT NULL COMMENT '门店id',
    `emp_id` varchar(64) DEFAULT NULL COMMENT '员工id',
    `hy_id` varchar(64) NOT NULL COMMENT '粉丝hyid',
    `open_id` varchar(200) DEFAULT NULL COMMENT '粉丝微信(公众号/小程序)openID',
    `nick_name` varchar(256) DEFAULT NULL COMMENT '粉丝昵称',
    `photo` varchar(500) DEFAULT NULL COMMENT '粉丝头像',
    `goods_id` varchar(64) DEFAULT NULL COMMENT '商品id',
    `goods_url` varchar(500) DEFAULT NULL COMMENT '商品链接',
    `goods_name` varchar(200) DEFAULT NULL COMMENT '商品名称',
    `goods_pic_url` varchar(500) DEFAULT NULL COMMENT '商品图片链接',
    `view_status` tinyint(4) DEFAULT NULL COMMENT '浏览状态: 0=正在浏览1=已浏览',
    `is_buy` tinyint(4) DEFAULT NULL COMMENT '是否购买: 0=否1=是',
    `is_keep` tinyint(4) DEFAULT NULL COMMENT '是否收藏: 0=否1=是',
    `live_time` int(11) DEFAULT NULL COMMENT '停留时长(秒)',
    `view_date` varchar(10) DEFAULT NULL COMMENT '浏览日期, 格式: yyyy-MM-dd',
    `view_time` varchar(8) DEFAULT NULL COMMENT '浏览时间, 格式: HH:mm:ss',
    `create_time` datetime NOT NULL COMMENT '创建时间',
    `data_source` int(11) NOT NULL COMMENT '数据来源：1=公众号（默认）,2=小程序',
    `type` int(2) NOT NULL COMMENT '0：活动广场  1：活动首页  2：商城首页  3：商品详情  4：商品列表 ',
    `wx_union_id` varchar(64) DEFAULT NULL COMMENT '微信开放平台unionId',
    `activity_id` varchar(64) DEFAULT NULL COMMENT '活动主键ID',
    `redirect_url` varchar(500) DEFAULT '' COMMENT '跳转地址',
    `appcode` int(4) DEFAULT NULL COMMENT '来源的应用标识',
    `uuid` varchar(64) DEFAULT NULL COMMENT '适配原id',
    PRIMARY KEY (`id`),
    KEY `idx_behavior_shop_id` (`shop_id`),
    KEY `idx_behavior_hy_id` (`hy_id`),
    KEY `idx_behavior_data_source` (`data_source`),
    KEY `idx_behavior_create_time` (`create_time`),
    KEY `idx_hy_id_create_time` (`hy_id`,`create_time`),
    KEY `idx_uuid_appcode` (`uuid`,`appcode`) USING BTREE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='粉丝足迹';
  </select>


</mapper>